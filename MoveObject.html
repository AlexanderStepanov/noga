<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="scripts/jquery-2.0.3.min.js"></script>
    <script type="text/javascript">
        var _shipX = 0;
        var _shipY = 0;
        var _nextPoint = new Object();
        var _isMoving = false;
        var _delay = 0;
        var _moveQueue = new Array();
        var _circleCenterX;
        var _circleCenterY = _circleCenterX = 134;

        $(document).ready(function() {
            startMoving();
        });

        function startMoving() {
            setCoordinates(134, 134);

//            setCoordinates(46, 235);
//            moveTo(47, 236);
//
//            setCoordinates(227, 227.5);
//            moveTo(228, 230);

//return;
            var tempDelay = 30;

            for(var i = 0; i < 360; i++){
                setTimeout(function(x)
                            {
                                return function(){
                                    setAngle(x);
                                }
                            }(i)
                        , tempDelay);

                tempDelay += 30;

//                setAngle(i);

            }
        }

        function setAngle(angle){
            var radius = 134;
            var alpha = Math.PI * 2;
            angle *= Math.PI / 180;
            var theta = alpha;

            var pointx  =  Math.floor(Math.cos( theta + angle) * radius);
            var pointy  = Math.floor(Math.sin( theta + angle) * radius );


            var xx = pointx + _circleCenterX;
            var yy = pointy + _circleCenterY;

//            alert("x:" + xx + " y:" + yy);

            moveTo(xx, yy);
        }

        function moveTo(x, y){
            var point = new Object();
            point.x = Math.round(x);
            point.y = Math.round(y);
            _moveQueue.push(point);

            //alert(_delayX);
            moveNext();

        }

        function moveNext(){

            //debugger;
//            console.log("entering moveNext");

            if(_isMoving || _moveQueue.length == 0) return;

            var nextPoint = dequeue();
            if(nextPoint == undefined) {
                finishMove();
                return;
            }
            _nextPoint = nextPoint;


            console.log("moving to " + _nextPoint.x + " " + _nextPoint.y);

            var differenceBetweenXs = Math.abs(_nextPoint.x - _shipX);
            var differenceBetweenYs = Math.abs(_nextPoint.y - _shipY);

            var allIterations = differenceBetweenXs > differenceBetweenYs ?
                    differenceBetweenXs : differenceBetweenYs;
            var oneIterationXStep = differenceBetweenXs / allIterations;
            var oneIterationYStep = differenceBetweenYs / allIterations;

            var iterations = 0;

            _delay = 3;

            while(iterations < allIterations){
                iterations++;

                _delay += 3;
//                $("#log").append("test<br/>");

                setTimeout(function(){
                    MoveToNextPoint(oneIterationXStep, oneIterationYStep);
                }, _delay);
            }
        }



        function MoveToNextPoint(oneIterationXStep, oneIterationYStep){
            _shipX = makeCloser(_shipX, _nextPoint.x, oneIterationXStep);
            _shipY = makeCloser(_shipY, _nextPoint.y, oneIterationYStep);

            setCoordinates(_shipX, _shipY);

            if(isMovedToEnd())
            {
                finishMove();
            }
        }

        function setCoordinates(x, y){
            _shipX = x;
            _shipY = y;

            $('#myDiv').css("left", Math.round(x));
            $('#myDiv').css("top", Math.round(y));
        }

        function isMovedToEnd(){
            if(_shipX == _nextPoint.x){
                if(_shipY + 1 == _nextPoint.y) return true;
            }

            if(_shipY == _nextPoint.y){
                if(_shipX + 1 == _nextPoint.x) return true;
            }

            return Math.ceil(_shipX) >= _nextPoint.x && Math.ceil(_shipY) >= _nextPoint.y;
        }

        function finishMove(){
            setCoordinates(_nextPoint.x, _nextPoint.y);
            _isMoving = false;
            moveNext();
        }

        function dequeue(){
            var result = _moveQueue[0];
            if(result == undefined) return undefined;
            _isMoving = true;
            _moveQueue.splice(0, 1);

            if(result.x == _shipX && result.y == _shipY){
                return dequeue();
            }

            return result;
        }

        function makeCloser(current, mustBe, closerValue){
            return current >= mustBe? current - closerValue : current + closerValue;
        }

        function showLastData(){
            alert("x: " + _shipX + " y: " + _shipY + "\r\n"
                    + "future: x: " + _nextPoint.x + " y: " + _nextPoint.y + "\r\n"
                    + "real: x: " + $('#myDiv').css("left") + " y: " + $('#myDiv').css("top"));
        }
    </script>
</head>
    <body>
        <!--<canvas id="myCanvas" width="288" height="288" />-->
        <img src="img/labyrinth.png" />
        <div id="myDiv" style="background-image: url('img/man.png'); width: 8px; height: 21px; position: absolute;"></div>
        <input type="button" onclick="showLastData();" value="show data" />
        <div id="log"></div>
    </body>
</html>
