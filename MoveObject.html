<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript">
        // Global variables
        var shipX = 0; // X position of ship
        var shipY = 0; // Y position of ship
        var canvas; // canvas
        var ctx; // context
        var back = new Image(); // storage for new background piece
        var oldBack = new Image(); // storage for old background piece
        var ship = new Image(); // ship
        var shipX = 0; // current ship position X
        var shipY = 0; // current ship position Y
        var oldShipX = 0; // old ship position Y
        var oldShipY = 0; // old ship position Y

        // This function is called on page load.

        var moveQueue = new Array();




        function canvasSpaceGame() {


            canvas = document.getElementById("myCanvas");

            if (canvas.getContext)
            {
                ctx = canvas.getContext("2d");

                // Paint it black.
                ctx.fillStyle = "black";
                ctx.rect(0, 0, 300, 300);
                ctx.fill();

                // Save the initial background.
                back = ctx.getImageData(0, 0, 30, 30);

                oldBack = ctx.getImageData(0, 0, 30, 30);
                // Draw space ship.
                makeShip();
            }

//            setInterval(MoveRight, 1);
            moveTo(200, 0);
            moveTo(200, 200);
            moveTo(0,200 );
            moveTo(200, 0);
            moveTo(200, 200);



        }

        var isDrawingNow = false;

        function drawNext(){
            if(isDrawingNow) return;
            isDrawingNow = true;
            if(moveQueue.length == 0) return;
            var point = moveQueue[0];

            oldShipX = shipX;
            oldShipY = shipY;
            oldBack = back;

            var z = 0;
            var x = point.x;
            var y = point.y;
            var xIsLast = point.x > point.y;

            for(i = oldShipX; i != x;)
            {
                var huy = x > i;

                if(huy){
                    i++;
                }
                else{
                    i--;
                }

                z += 3;
                setTimeout(function(value) { return function() {
                    if(huy){
                        shipX = shipX + 1;
                    }
                    else{
                        shipX = shipX - 1;
                    }

                    back = ctx.getImageData(shipX, shipY, 30, 30);
                    doGameLoop();

                    if(xIsLast && value == x)
                    {
                        moveQueue.splice(0, 1);
                        isDrawingNow = false;
                        drawNext();
                    }

                } }(i) ,z);

            }
            z=0;
            for(j = oldShipY; j != y;)
            {
                z+=3;

                var pizda = y > j;

                if(pizda){
                    j++;
                }
                else{
                    j--;
                }

                setTimeout(function(value) { return function() {
                    if(pizda){
                    shipY = shipY + 1;
                    }
                    else{
                        shipY = shipY - 1;
                    }
                    back = ctx.getImageData(shipX, shipY, 30, 30);
                    doGameLoop();

                    if(!xIsLast && value == y)
                    {
                        moveQueue.splice(0, 1);
                        isDrawingNow = false;
                        drawNext();
                    }

                } }(j) ,z);
            }
        }

        function moveTo(x, y){
            var point = new Object();
            point.x = x;
            point.y = y;
            moveQueue.push(point);

            drawNext();





//            shipX = shipX + 1;
//            if (shipX > 270) {
//
//                shipX = 270;
//            }


        }

        function makeShip() {

            // Draw saucer bottom.
            ctx.beginPath();
            ctx.moveTo(28.4, 16.9);
            ctx.bezierCurveTo(28.4, 19.7, 22.9, 22.0, 16.0, 22.0);
            ctx.bezierCurveTo(9.1, 22.0, 3.6, 19.7, 3.6, 16.9);
            ctx.bezierCurveTo(3.6, 14.1, 9.1, 11.8, 16.0, 11.8);
            ctx.bezierCurveTo(22.9, 11.8, 28.4, 14.1, 28.4, 16.9);
            ctx.closePath();
            ctx.fillStyle = "rgb(222, 103, 0)";
            ctx.fill();

            // Draw saucer top.
            ctx.beginPath();
            ctx.moveTo(22.3, 12.0);
            ctx.bezierCurveTo(22.3, 13.3, 19.4, 14.3, 15.9, 14.3);
            ctx.bezierCurveTo(12.4, 14.3, 9.6, 13.3, 9.6, 12.0);
            ctx.bezierCurveTo(9.6, 10.8, 12.4, 9.7, 15.9, 9.7);
            ctx.bezierCurveTo(19.4, 9.7, 22.3, 10.8, 22.3, 12.0);
            ctx.closePath();
            ctx.fillStyle = "rgb(51, 190, 0)";
            ctx.fill();

            // Save ship data.
            ship = ctx.getImageData(0, 0, 30, 30);

            // Erase it for now.
            ctx.putImageData(oldBack, 0, 0);

        }

        function doGameLoop() {

            // Put old background down to erase shipe.
            ctx.putImageData(oldBack, oldShipX, oldShipY);

            // Put ship in new position.
            ctx.putImageData(ship, shipX, shipY);
        }


        
    </script>
</head>
<body onload="canvasSpaceGame()">
    <h1>Canvas Space Game</h1>
    <canvas id="myCanvas" width="300" height="300"/>
    </body>
</html>
